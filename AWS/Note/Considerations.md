# 시스템 설계 고려 사항

## 웹 가용성 향상 패턴 포인트

### Multi AZ에 걸쳐 장애 대응하기

웹서버와 DB가 다른 AZ여도 통신 지연은 ms 정도다. 시스템 정지 예방을 위해 여러 AZ에 서버를 배치하자.

### 웹서버를 Stateless 형식으로 구축하기

AS가 가능한 인프라를 설계했을 경우, `Fluentd`같은 로그 수집 툴을 활용해 로그를 저장하도록 설계하자

### AMI vs UserData

AMI 방식 : UserData 방식에 비하여 부팅 시간이 짧지만, 관리가 복잡
<br>
UserData 방식 : 스크립트를 통해 인프라 구성이 파악 및 변경 이력 파악 가능
<br>
서비스의 특성에 따라 위 2가지의 방법 및 혼용이 가능하므로 최적의 패턴을 고려하자.

<br>

### CLA vs ALB

ALB 고유 기능

- URL 패턴에 따라 Target을 변경하는 콘텐츠 기반 라우팅 기능
- 하나의 인스턴스에 여러 포트에서 부하 분산 가능
- 웹소켓, HTTP/2에 대응
- CLB보다 약간 저렴

CLB 고유 기능

- L4 레벨의 부하 분산 (메일 서버가 이중화 돼어 있는 경우 내부로 SMTP 통신의 로드 벨런싱에 사용)

<br>

## 콘텐츠 캐시 패턴

요청을 받는 CDN으로 CF를 채택하고 동적 콘텐츠는 ELB와 EC2로, 그 외의 정적 콘텐츠 및 오류 페이지는 S3에서 반환하는 설계

### 업데이트 빈도를 고려한 캐시 TTL 설정

URL 경로마다 캐시 TTL의 지정을 바꿀 수 있기 때문에 자주 업데이트되는 정적 콘텐츠는 TTL을 짧게, 그 외의 콘텐츠는 TTL은 길게 설정 가능

### Popular Object Report를 참고해 정기적으로 설정 재검토를 실시

Popular Object Report : 요청된 콘텐츠마다 캐시 적중률을 리포팅

### Origin 서버의 장애를 고려한 설계

오리진 서버에서 50X 응답이 오면, S3에서 에러 페이지를 가져오도록 CF를 설정해 구현

### CloudWatch를 사용해 알람 수신

<br>

## DB 가용성 향상 패턴

Stateless한 서버와 달리, DB는 데이터의 상태를 유지하기 위해 Statefull 할 수 밖에 없다. 가용성을 높이기 위해 복제 및 미러링을 사용한다.

### 운용 포인트

1. CloudWatch를 사용해 Scale-Up 타이밍 놓치지 않기
2. M-S 구성으로 유지보수 시간 단축하기 (장애조치에 걸린 시간만이 서비스 정지 시간, 약 60~120초)

<br>

## 인 메모리 캐시 패턴

웹서버에서 DB로 쿼리를 실행했을 때 결과를 캐시에 저장해 두고, 이후의 액세스는 데이터베이스가 아니라 캐시에서 데이터를 반환해 부하를 줄임

### ElastiCache

Memcached와 Redis의 클러스터 구성도 쉽게 할 수 있고 가용성 향상을 쉽게 실현.
반대로 일부 기능과 설정에 제한이 생긴다. Redis의 경우 config 및 migrate라는 일부 명령어를 사용할 수 없고, 패스워드 설정이 불가에 보안 그룹별로 액세스 제한을 가해야 한다.

- Memcached : 멀티 스레드로 실행하고 간단한 데이터 구조만 취급. 휘발성 데이터를 보관하며 백업 기능이 없음.
  CacheCluster라는 논리 그룹을 정의하고 클러스터링 하며 AutoDiscovery 기능을 이용해 각 노드의 엔드포인트를 의식하지 않고 액세스 할 수 있다.
  따라서 자동으로 연결 대상을 추가하거나 제거하지만 .NET, PHP, Java 등과 같은 일부 클라이언트 라이브러리에 대응한다.

- Redis : 싱글 스레드로 실행하고 문자열을 비롯해 리스트 및 비트맵 등 복잡한 데이터 형 취급 가능. 자동으로 스냅샷을 취득하거나 `스냅샷 <-> .rdb`로의 변환과 멀티 AZ의 리드 레플리카를 구성함으로써 읽기 성능을 높이고 장애 조치를 설정 할 수 있다.

### 도입 포인트

1. 캐시 데이터 선정
   > 재고 수량과 같은 업데이트가 자주 이뤄지는 것들은 캐시의 효과가 적다.
2. 애플리케이션 수정
3. 복원력을 높이는 설계
   > Memcached <br>
   > CacheCluster를 구성해 노드를 여러개를 AZ에 걸쳐 설정, AutoDiscovery 활성화
   >
   > Redis <br>
   > AZ에 걸치는 형태로 리드 레플리카를 준비해 장애를 견디는 구성 설계 (승격에 걸리는 시간 동안 캐시를 사용하지 않고 DB에 액세스하는 오류 처리 필요)
4. 부하 테스트로 적절한 인스턴스 유형 설정
   > 웹서버 EC2 인스턴스보다 작은 것을 추천

<br>

## 작업 서버 패턴

NAT 게이트웨이와 VPC 엔드포인트를 이용해, 프라이빗 서브넷의 서버에서 인터넷 통신 및 API의 이용을 가능하게함.

### 구축 포인트

1. AZ에 의존하지 않는 설계를 하고 콜드 스탠바이 대기는 준비하지 않는다.
2. VPC 엔드포인트와 네트워크 ACL을 병용할 때의 주의 사항 <br>
   NACL을 설정하고 Private IP 주소 이외의 연결을 명시적으로 거부할 수 있습니다. VPC 엔드포인트를 병용하는 경우에는 주의가 필요합니다. VPC 엔드포인트로 향하는 통신은 S3 or DDB의 글로벌 IP 주소로 라우팅됩니다.
   즉, NACL에서 글로벌 IP 주소와 통신을 거부하는 경우 VPC 엔드포인트를 이용한 통신이 불가능합니다.

- 보안 그룹으로 해결하기
  - 프라이빗 IP 주소를 향한 Outbound 통신만 허용하는 보안 그룹 생성
  - 이 보안 그룹에 접두사 목록 ID(VPC 엔드포인트의 퍼블릭 IP 주소의 범위)를 추가
- 라우팅 테이블로 해결하기
  - 해당 서브넷의 라우팅 테이블은 IGW용 경로를 만들지 않음
  - 이 라우팅 테이블에 VPC 엔드포인트로 가는 경로를 추가

<br>

---

Reference : [AWS 시스템 설계와 마이그레이션](http://www.yes24.com/Product/Goods/67031301)
